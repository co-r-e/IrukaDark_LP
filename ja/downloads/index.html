<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IrukaDark — ダウンロード</title>
    <meta name="description" content="IrukaDark をダウンロード（Windows x64 / macOS arm64 / Linux x64）。" />
    <link rel="canonical" href="https://irukadark.com/ja/downloads" />
    <link rel="icon" href="../../icons/favicon.svg" type="image/svg+xml" />
    <link rel="icon" href="../../icons/icon.png" type="image/png" />
    <link rel="apple-touch-icon" href="../../icons/icon.png" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../../styles.css" />
    <script>window.DEFAULT_LANG = 'ja';</script>
  </head>
  <body>
    <div class="bg fx-grid"></div>
    <div class="bg fx-radial fx-radial-1"></div>
    <div class="bg fx-radial fx-radial-2"></div>
    <div class="bg fx-noise"></div>

    <header class="nav">
      <div class="container">
        <a class="brand" href="#">
          <img src="../../icons/logo.svg" alt="IrukaDark（イルカダーク）" class="brand-logo lg" />
        </a>
        <nav class="nav-actions">
          <div class="lang-dropdown">
            <button class="lang-trigger" id="langTrigger" aria-haspopup="true" aria-expanded="false">
              <svg class="globe-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="12" cy="12" r="9"/>
                <path d="M3 12h18"/>
                <path d="M12 3a15 15 0 0 1 0 18"/>
                <path d="M12 3a15 15 0 0 0 0 18"/>
              </svg>
              <span class="lang-text" id="langCode">JA</span>
            </button>
            <div class="lang-menu" id="langMenu">
              <button class="lang-option" data-lang="en">
                <span class="lang-text">English</span>
              </button>
              <button class="lang-option" data-lang="ja">
                <span class="lang-text">日本語</span>
              </button>
            </div>
          </div>
          <a id="download-nav" href="/ja/downloads" class="btn btn-primary" data-i18n="header.clone">ダウンロード</a>
        </nav>
      </div>
    </header>

    <main>
      <section class="container section">
        <div class="section-head">
          <h1 class="section-title">IrukaDark をダウンロード</h1>
          <p class="section-sub">お使いのOSを自動判定し、最適なインストーラをご案内します。下に全ファイル一覧も表示します。</p>
        </div>

        <div class="cta glass" style="margin-top:8px;">
          <div class="cta-copy">
            <h3 class="cta-title" id="osDetectedTitle">OS を検出しました</h3>
            <p class="cta-sub" id="osDetectedNote">検出結果に基づいて、適切なダウンロードを表示します。</p>
          </div>
          <div class="cta-actions">
            <a id="download-primary" href="https://github.com/co-r-e/IrukaDark/releases/latest" class="btn btn-primary btn-lg">ダウンロード</a>
          </div>
        </div>

        <div class="section" style="margin-top:24px;">
          <h2 class="section-title" style="font-size:20px;">すべてのダウンロード</h2>
          <div id="assets" class="card glass" style="padding:16px;">
            <p id="assetsStatus" class="muted">最新リリースのアセットを読み込み中…</p>
            <ul id="assetList" class="icon-list"></ul>
          </div>
          <div style="margin-top:12px;">
            <a class="link" href="https://github.com/co-r-e/IrukaDark/releases/latest" target="_blank" rel="noopener">GitHub Releases で見る</a>
          </div>
        </div>

        <div class="section" style="margin-top:24px;">
          <h2 class="section-title" style="font-size:20px;">ハッシュ値（チェックサム）</h2>
          <div id="checksums" class="card glass" style="padding:16px;">
            <p id="checksumsStatus" class="muted">SHA256SUMS を探しています…</p>
            <pre id="checksumsPre" class="muted" style="white-space:pre-wrap; word-break:break-word;"></pre>
            <p id="sigInfo" class="muted" style="margin-top:8px;"></p>
          </div>
        </div>

        <div class="section" style="margin-top:24px;">
          <h2 class="section-title" style="font-size:20px;">初回起動の注意</h2>
          <div class="card glass" style="padding:16px;">
            <ul class="icon-list">
              <li>
                <b>macOS（arm64）:</b> 「開発元が未確認のため開けません」等のGatekeeper警告が出たら、アプリをControl+クリック→「開く」で許可してください。もしくは「システム設定 → プライバシーとセキュリティ」で許可します。
              </li>
              <li>
                <b>Windows:</b> SmartScreenの「WindowsによってPCが保護されました」が出た場合は「詳細情報」→「実行」を選びます。将来的にコード署名でこの警告は軽減されます。
              </li>
              <li>
                <b>Linux AppImage:</b> 実行権限を付与（右クリック→プロパティ→権限→「プログラムとして実行を許可」または <code>chmod +x IrukaDark-*.AppImage</code>）してから起動してください。
              </li>
              <li>
                <b>画面キャプチャ許可（macOS）:</b> スクリーンショット解析を使う際に「画面収録」の許可が必要です。最初の実行時に案内に従って許可してください。
              </li>
            </ul>
          </div>
        </div>
      </section>
    </main>

    <footer class="container footer">
      <div class="foot-left">
        <span class="muted">© <span id="year"></span> CORe, Inc. All rights reserved.</span>
      </div>
      <div class="foot-right">
        <a class="link" href="https://co-r-e.net" target="_blank" rel="noopener">Company</a>
        <a class="link" href="https://co-r-e.net/contact" target="_blank" rel="noopener">Contact</a>
      </div>
    </footer>

    <script src="../../app.js"></script>
    <script>
      (function(){
        const REPO = 'co-r-e/IrukaDark';
        const STABLE = {
          windows: 'IrukaDark-Setup-x64.exe',
          mac: 'IrukaDark-macOS-arm64.dmg',
          linux: 'IrukaDark-x86_64.AppImage'
        };
        const primary = document.getElementById('download-primary');
        const statusEl = document.getElementById('assetsStatus');
        const listEl = document.getElementById('assetList');
        const titleEl = document.getElementById('osDetectedTitle');
        const noteEl = document.getElementById('osDetectedNote');

        function detectOS(){
          const ua = navigator.userAgent || navigator.platform || '';
          if (/Windows/i.test(ua)) return 'windows';
          if (/Macintosh|Mac OS X|MacOS/i.test(ua)) return 'mac';
          if (/Linux|X11/i.test(ua) && !/Android/i.test(ua)) return 'linux';
          return null;
        }
        function osLabel(os){
          const map = { windows: 'Windows（x64）', mac: 'macOS（arm64）', linux: 'Linux（x64）' };
          return map[os] || '不明なOS';
        }
        function pickAsset(assets, os){
          const byName = (re) => assets.find(a => a && a.name && re.test(a.name));
          if (os === 'windows') return byName(/\.exe$/i) || byName(/\.msi$/i) || null;
          if (os === 'mac') return byName(/arm64.*\.dmg$/i) || byName(/\.dmg$/i) || byName(/\.pkg$/i) || null;
          if (os === 'linux') return byName(/x86_64.*\.AppImage$/i) || byName(/\.AppImage$/i) || byName(/amd64.*\.deb$/i) || byName(/x86_64.*\.rpm$/i) || null;
          return null;
        }
        function fmtSize(bytes){
          if (!bytes && bytes !== 0) return '';
          const units = ['B','KB','MB','GB'];
          let i=0, n=bytes;
          while(n>=1024 && i<units.length-1){ n/=1024; i++; }
          return n.toFixed(1)+' '+units[i];
        }

        async function run(){
          const os = detectOS();
          if (titleEl) titleEl.textContent = 'OS を検出しました';
          if (noteEl) noteEl.textContent = os ? osLabel(os) + ' を検出しました — 最適なダウンロードを表示します。' : 'OS を判定できませんでした — 下の一覧から選択してください。';

          primary.href = `https://github.com/${REPO}/releases/latest`;
          try{
            const res = await fetch(`https://api.github.com/repos/${REPO}/releases/latest`, { headers: { 'Accept': 'application/vnd.github+json' } });
            if (!res.ok) throw new Error('GitHub API error');
            const rel = await res.json();
            const assets = Array.isArray(rel.assets) ? rel.assets : [];
            if (assets.length === 0){
              if (os && STABLE[os]){
                primary.href = `https://github.com/${REPO}/releases/latest/download/${encodeURIComponent(STABLE[os])}`;
                primary.textContent = osLabel(os) + ' をダウンロード';
              }
              statusEl.textContent = '最新リリースにアセットがありません。';
              return;
            }

            const a = os ? pickAsset(assets, os) : null;
            if (a && a.browser_download_url){
              primary.href = a.browser_download_url;
              primary.textContent = osLabel(os) + ' をダウンロード';
            } else if (os && STABLE[os]){
              primary.href = `https://github.com/${REPO}/releases/latest/download/${encodeURIComponent(STABLE[os])}`;
              primary.textContent = osLabel(os) + ' をダウンロード';
            } else {
              primary.textContent = '最新リリースを開く';
            }

            statusEl.style.display = 'none';
            listEl.innerHTML = '';
            assets.forEach(asset => {
              const li = document.createElement('li');
              const link = document.createElement('a');
              link.href = asset.browser_download_url;
              link.textContent = asset.name + (asset.size ? `（${fmtSize(asset.size)}）` : '');
              link.className = 'link';
              li.appendChild(link);
              listEl.appendChild(li);
            });

            // Checksums (SHA256SUMS)
            const cStatus = document.getElementById('checksumsStatus');
            const cPre = document.getElementById('checksumsPre');
            const sigInfo = document.getElementById('sigInfo');
            const sumAsset = assets.find(a => /^(sha256sums(\.txt)?|checksums(\.txt)?)$/i.test(a.name));
            const sigAsset = assets.find(a => /^(sha256sums\.sig)$/i.test(a.name));
            if (sumAsset){
              try{
                const r = await fetch(sumAsset.browser_download_url);
                if (!r.ok) throw new Error('fetch sums');
                const text = await r.text();
                cStatus.style.display = 'none';
                cPre.textContent = text.trim();
                if (sigAsset){
                  sigInfo.innerHTML = `署名: <a class="link" href="${sigAsset.browser_download_url}">SHA256SUMS.sig</a>`;
                }
              }catch(e){
                cStatus.textContent = 'チェックサムを読み込めませんでした。';
              }
            } else {
              cStatus.textContent = 'チェックサムは提供されていません（任意）。';
            }
          }catch(e){
            if (os && STABLE[os]){
              primary.href = `https://github.com/${REPO}/releases/latest/download/${encodeURIComponent(STABLE[os])}`;
              primary.textContent = osLabel(os) + ' をダウンロード';
            }
            statusEl.textContent = 'リリース情報を取得できませんでした。上のボタンからダウンロードしてください。';
            const cStatus = document.getElementById('checksumsStatus');
            cStatus.textContent = 'チェックサムを読み込めませんでした。';
          }
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run); else run();
      })();
    </script>
  </body>
  </html>
